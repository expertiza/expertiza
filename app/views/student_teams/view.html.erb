<h1 xmlns="http://www.w3.org/1999/html">Team Information for <%= @student.assignment.name %></h1>

<% unless @has_team %>
    <h3>Name team</h3>
    <%= form_tag :controller => 'student_teams', :action => 'create' do %>
        <%= hidden_field_tag 'student_id', @student.id %>
        <label for="team_name">Team name:</label>&nbsp;
        <%= text_field 'team', 'name' %>
        <%= submit_tag "Name team" %>
    <% end %>
<% else %>
    <h3>Team Name</h3><%= @student.team.name %>
    <%= link_to "Edit name", edit_student_teams_path(team_id: @student.team.id, student_id: @student.id) %>
    <br/><br/>
    <h3>Team members</h3>
    <!--start team member table-->
    <table style="width:80%" align="center" >
      <tr style="border: 1px outset #000000; padding: 10px 20px" >
        <th class="head">Username</th>
        <th class="head">Full name</th>
        <!--<th class="head">Team-member role (duty)</th>-->
        <th class="head">Email address</th>
        <% if @teammate_review_allowed %>
            <th class="head">Review action</th>
        <% end %>
      </tr>

      <% for member in @student.team.participants %> <!--start team member content-->
          <tr>
            <td><%= member.user.name %></td>
            <td><%= member.user.fullname %></td>
            <td><%= member.user.email %></td>

            <!--if you can review a teammate, display Review hyperlink; if the review has been done, display View and Edit Hyperlinks-->
            <% if @teammate_review_allowed %>
                <% if @student.assignment.questionnaires.find_by_type('TeammateReviewQuestionnaire') != nil and member.user.id != session[:user].id %>
                    <% map = TeammateReviewResponseMap.where(['reviewer_id = ? and reviewee_id = ?', @student.id, member.id]).first
                       if map.nil?
                         map = TeammateReviewResponseMap.create(:reviewer_id => @student.id, :reviewee_id => member.id, :reviewed_object_id => @student.assignment.id)
                       end
                       review = map.response.last
                       if review.nil? %>
                        <td>
                          <%= link_to "Review", {:controller => 'response', :action => 'new', :id => map.map_id, :return => "teammate"} %>
                        </td>
                    <% else %>
                        <td>
                          <%= link_to "View", {:controller => 'response', :action => 'view', :id => review.id} %>
                          &nbsp;&nbsp;
                          <%= link_to "Edit", {:controller => 'response', :action => 'edit', :id => review.id, :return => "teammate"} %>
                        </td>
                    <% end %>
                <% end %>
            <% end %>
          </tr>
      <% end %>   <!--end team member content-->
      <tr>
        <td colspan="3">
          <br/>
          <%= link_to "Leave team", remove_participant_student_teams_path(student_id: @student.id, team_id: @student.team.id) %>
        <td>
      </tr>
    </table>

    <!--display a list of sent join-team requests-->
    <%= render :partial => 'join_team_requests/list_sent',
               :locals =>{:teams_user_id=>params[:student_id],
                          :assignment_id => @student.assignment.id
               } %>
    <br>

    <!--render partial for join team request-->
    <%= render :partial => 'join_team_requests/list_received',
               :locals =>{:team_id=>@student.team.id,
                          :teams_user_id=>params[:student_id],
                          :assignment_id => @student.assignment.id} %>

    <% if @send_invs && @send_invs.length > 0 %>
        <br/>
        <h3>Sent invitations</h3>
        <!-- start invited people table -->
        <table style="width:80%" align="center" >
          <tr style="border: 1px outset #000000; ">
            <th class="head"><b>Username</b></th>
            <th class="head"><b>Full name</b></th>
            <th class="head"><b>Email address</b></th>
            <th class="head" align="center"><b>Status</b></th>
          </tr>
          <% for inv in @send_invs %>
              <tr>
                <td><%= inv.to_user.name %></td>
                <td><%= inv.to_user.fullname %></td>
                <td><%= inv.to_user.email %></td>
                <% if inv.reply_status == 'A' %>
                    <td align = "center">Accepted</td>
                <% elsif inv.reply_status == 'D' %>
                    <td align = "center">Declined</td>
                <% else %>
                    <td align = "center">Waiting for reply
                      &nbsp;&nbsp;<%= link_to "Retract", {:controller => 'invitations', :action => 'cancel', :inv_id => inv.id, :student_id => @student.id} %></td>
                <% end %>
              </tr>
          <% end %>
        </table>
        <!-- start invited people table -->
    <% end %>
    <br/>

    <!--waiting listed users on the same topic-->
    <% if @users_on_waiting_list && @users_on_waiting_list.count>0%>
        <h3>Users waiting for this topic:</h3>
        <table>
          <tr>
            <td><b>&nbsp; User id &nbsp; </b></td>
            <td><b>&nbsp; Full name &nbsp; </b></td>
            <td><b>&nbsp; Email &nbsp; </b></td>
          </tr>
          <% @users_on_waiting_list.each do |user|%>
              <tr>
                <td> &nbsp; <%=user.name%> &nbsp; </td>
                <td> &nbsp; <%=user.fullname%> &nbsp; </td>
                <td> &nbsp; <%=user.email%> &nbsp; </td>
              </tr>
          <% end%>
        </table>
    <% end %>

<% end %>

<!--display a table of received invitation-->
  <% if @received_invs && @received_invs.length > 0 %>
    <table style="width:80%" align="center" >
      <h3>Received Invitations</h3>
      <tr style="border: 1px outset #000000; padding: 10px 20px" >
        <th class="head">From </th>
        <th class="head">Team Name </th>
        <th class="head">Reply </th>
      </tr>
      <% for inv in @received_invs %>
          <% if inv.reply_status == 'W' %>
              <tr>
                <td><%= inv.from_user.name %></td>
                <td>
                  <% teamsusers = TeamsUser.where(['user_id = ?', inv.from_id]) %>
                  <% for teamsuser in teamsusers %>
                      <% current_team = Team.where(['id = ? and parent_id = ?', teamsuser.team_id, @student.assignment.id]).first %>
                      <% if current_team != nil %>
                          <%= Team.find(current_team.id).name %>
                      <% end %>
                  <% end %>
                </td>
                <td>
                  <%if @student.team == nil
                      @team_id = 0
                    else
                      @team_id = @student.team.id
                    end %>
                  <%= link_to "Accept",
                              {:controller => 'invitations', :action => 'accept', :inv_id => inv.id, :student_id => @student.id, :team_id => @team_id},
                              {:onClick => "javascript: return confirm('Your topic (or place on waiting lists) will be relinquished if you accept the invitation. Do you want to continue?');"}
                  %>
                  |
                  <%= link_to "Decline",
                              {:controller => 'invitations', :action => 'decline', :inv_id => inv.id, :student_id => @student.id}
                  %>
                </td>
              </tr>
          <% end %>
      <% end %>
    </table>

  <% end %>
<br/>

<!--send invitation-->
<% if @has_team && @can_send_invitation %>
    <h3>Send new Invitation</h3>
    <b>Invite people</b>
    <%= form_tag :controller => 'invitations', :action => 'create' do %>
        <%= hidden_field_tag 'team_id', @student.team.id %>
        <%= hidden_field_tag 'student_id', @student.id %>
        <%= hidden_field_tag 'session[:dummy][:assignment_id]', @student.parent_id %>
        <table style="width:80%" align="center" >
          <tr>
            <td>
              Enter user login: <%= text_field_with_auto_complete :user, :name, {:size => 41} %>
              <input type='submit' value='Invite'/>
            </td>
          </tr>
        </table>
    <% end %>

    <!-- Create advertisements -->
    <b>Advertisement for teammates</b>
    <br>
    <table style="width:80%" align="center" >
      <tr>
        <td>
          <% if @student.team && @student.team.advertise_for_partner%>
              <%= @student.team.comments_for_advertisement%>
              &nbsp;&nbsp;&nbsp;&nbsp;
              <%= link_to 'Edit', :controller => 'advertise_for_partner', :action => 'edit', :team_id=>@student.team.id %>
              &nbsp;&nbsp;
              <%= link_to 'Delete', :controller => 'advertise_for_partner', :action => 'remove', :team_id=>@student.team.id %>
          <% else %>
              <%= link_to 'Create', :controller => 'advertise_for_partner', :action => 'new', :team_id=>@student.team.id %>
          <% end %>
        </td>
      </tr>
    </table>

    <!-- display a list of students who do not have a team with invitation links -->
    <h5><strong>Invite team mates to join your team</strong></h5>
    <%= render :partial => 'join_team_requests/list_not_initiated',
               :locals =>{:assignment_id => @student.assignment.id} %>
    <br>

<% end %>

   <a href="javascript:window.history.back()">Back</a>

