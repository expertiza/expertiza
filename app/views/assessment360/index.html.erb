<style>
  th, td {
    text-align: center;
}
</style>

<input class = "toggleColumns" type="checkbox" data-target="teammate_count" checked> teammate_count
<input class = "toggleColumns meta_review_checkbox assignment_columns aggregate_columns" type="checkbox" data-target="meta_review" checked> meta_review
<input class = "toggleColumns teammate_review_checkbox assignment_columns aggregate_columns" type="checkbox" data-target="teammate_review" checked> teammate_review
<input class = "toggleColumns topic_checkbox assignment_columns" type="checkbox" data-target="topic" checked> topic
<input class = "toggleColumns peer_score_checkbox assignment_columns" type="checkbox" data-target="peer_score" checked> peer_score
<input class = "toggleColumns instructor_grade_checkbox assignment_columns" type="checkbox" data-target="instructor_grade" checked> instructor_grade
<input class = "toggleColumns total_instructor_grade_checkbox" type="checkbox" data-target="tot_instructor_grade" checked> total_instructor_grade

<script>
    function validate_aggscore()
    {
        var meta_presence = document.getElementsByClassName("meta_review_checkbox")[0];
        var teammate_presence = document.getElementsByClassName("teammate_review_checkbox")[0];
        var shcolumn1 = '.aggregate_score';
        if(!meta_presence.checked && !teammate_presence.checked)
        {
            $(shcolumn1).hide();
        }
        else {
            $(shcolumn1).show();
        }
    }
    function validate_finalgrades()
    {
        var total_instructor_grade_presence = document.getElementsByClassName("total_instructor_grade_checkbox")[0];
        var shcolumn2 = '.final_grades';
        $(shcolumn2).toggle();
    }

    function check_colspan()
    {
        var assignment_colspan_value = 5;
        var aggregate_colspan_value = 2;

        var tabcol1 = $('input.assignment_columns:not(":checked")').length;
        assignment_colspan_value = assignment_colspan_value - tabcol1;
        // console.log(assignment_colspan_value);

        assignment_colspan = document.getElementsByClassName("assgn_colspan");
        $(assignment_colspan).attr('colspan', assignment_colspan_value);
        // console.log($(assignment_colspan).attr('colspan', assignment_colspan_value));

        var tabcol2 = $('input.aggregate_columns:not(":checked")').length;
        aggregate_colspan_value = aggregate_colspan_value - tabcol2;

        aggregate_colspan = document.getElementsByClassName("aggregate_score");
        $(aggregate_colspan).attr('colspan', aggregate_colspan_value);
        // console.log($(assignment_colspan).attr('colspan', assignment_colspan_value));

    }

    $(function() {
        $('.toggleColumns').on('change', function (e)
        {
            var tableColumn = $(e.currentTarget).data('target');
            $('.' + tableColumn).toggle();
            check_colspan();
            if(tableColumn == "meta_review" || tableColumn == "teammate_review")
            {
                validate_aggscore();
            }
            else if(tableColumn == "tot_instructor_grade")
            {
                validate_finalgrades();
            }
            else{}
        });
    });

</script>

<div id="wrap-table" style="position:relative; overflow:auto; width:100%">
  <table class="table table-striped">
    <tr>
      <th rowspan=2 >Students</th>
      <th class="teammate_count" rowspan=2 >Teammate Count</th>
      <% @assignments.each do |assignment| %>
        <th class="assgn_colspan" colspan = "5"> <%= assignment.name %> </th>
      <% end %>
      <th class="aggregate_score" colspan="2">Aggregate Score</th>
      <th class="final_grades" colspan="2">Final Grades</th>
    </tr>

    <tr>
      <% (1..@assignments.size).each do %>
        <th class="meta_review"><b>Metareviews</b></th>
        <th class="teammate_review"><b>Teammate Reviews</b></th>
        <th class="topic topic-tooltip"><b>Topic</b></th>
        <th class="peer_score"><b>Peer Score</b></th>
        <th class="instructor_grade"><b>Instructor Grade</b></th>
      <% end %>
      <th class="meta_review"><b>Metareviews</b></th>
      <th class="teammate_review"><b>Teammate Reviews</b></th>
      <th class="sorter-true tot_instructor_grade"><b>Total Instructor Grade</b></th>
    </tr>

    <% @course_participants.each do |cp|%>
        <tr>
            <td align="center"><%= "#{cp.name(session[:ip])} (#{cp.fullname(session[:ip])})" %> </td>
            <td class="teammate_count"><%= @teamed_count[cp.id] %></td>
            <% @assignments.each do |assignment|%>
                <td class="meta_review"><%= format_percentage(@meta_review[cp.id][assignment.id]) unless @meta_review.nil? %></td>
                <td class="teammate_review"><%= format_percentage(@teammate_review[cp.id][assignment.id]) unless @teammate_review.nil? %></td>
                <% topic = format_topic(@topics[cp.id][assignment.id]) %>
                <td title="<%= topic %>" class="topic topic-tooltip">
                  <%= topic %>
                </td>
                <td class="peer_score"><%= format_score(@peer_review_scores[cp.id][assignment.id]) %></td>
                <td class="instructor_grade"><%= format_score(@assignment_grades[cp.id][assignment.id]) %> </td>
            <% end%>
            <td class="meta_review"><%= format_percentage(@meta_review[:aggregate_score][cp.id]) unless @meta_review.nil? %></td>
            <td class="teammate_review"><%= format_percentage(@teammate_review[:aggregate_score][cp.id]) unless @teammate_review.nil? %></td>
            <td class="tot_instructor_grade"><%= @final_grades[cp.id] %></td>
        </tr>
    <%end%>
        <tr>
            <td><b>Class Average</b></td>
            <td></td>
            <% @assignments.each do |assignment|%>
                <td class="meta_review"><%= format_percentage(@meta_review[:class_avg][assignment.id]) unless @meta_review.nil? %></td>
                <td class="teammate_review"><%= format_percentage(@teammate_review[:class_avg][assignment.id]) unless @teammate_review.nil? %></td>
                <td></td>
                <td></td>
                <td></td>
            <% end%>
          <td class="meta_review"><%= format_percentage(@meta_review[:aggregate_score_class_avg]) unless @meta_review.nil? %></td>
          <td class="teammate_review"><%= format_percentage(@teammate_review[:aggregate_score_class_avg]) unless @teammate_review.nil? %></td>
          <td></td>
        </tr>
    </table>
</div>