<!-- PARTICIPANT -->
<% 
  participant = pscore[:participant]
  if pscore[:review]
  	s_max = pscore[:review][:scores][:max]
  	s_min = pscore[:review][:scores][:min] 
  	s_avg = pscore[:review][:scores][:avg] 
  end
  if pscore[:metareview]
    r_max = pscore[:metareview][:scores][:max]
  	r_min = pscore[:metareview][:scores][:min] 
  	r_avg = pscore[:metareview][:scores][:avg]
  end 
  if pscore[:feedback]
  	f_max = pscore[:feedback][:scores][:max]
  	f_min = pscore[:feedback][:scores][:min] 
  	f_avg = pscore[:feedback][:scores][:avg]
  end
  if pscore[:teammate]
  	tr_max = pscore[:teammate][:scores][:max]
  	tr_min = pscore[:teammate][:scores][:min] 
  	tr_avg = pscore[:teammate][:scores][:avg]   
  end  	
%>

<TR class="row" <% if team %> id="<%= prefix %>" style="display:none" <% end %>>
    <TD><%= participant.fullname %>
    <BR/><FONT SIZE="-1"><a href="#" id="<%=prefix%>_filesLink" name="<%=prefix%>_filesLink" onClick="toggleElement('<%=prefix%>_files','submission');return false;">show submission</a></FONT>  	
    </TD>
    
    <% if s_avg %>
  	<TD ALIGN="CENTER" VALIGN="TOP"><%= sprintf("%.2f",s_avg) %>%
  	<BR/><FONT SIZE="-1"><a href="#" id="<%=prefix%>_reviewsLink" name="<%=prefix%>_reviewsLink" onClick="toggleElement('<%=prefix%>_reviews','reviews');return false;">show reviews</a></FONT>
  	</TD>    
   	<TD ALIGN="CENTER" VALIGN="TOP"><%= sprintf("%.0f",s_min) %>% - <%= sprintf("%.0f",s_max) %>% 
   	<% if controller.action_name != "view_my_scores" %>
   	  <BR/><FONT SIZE="-1"><%= link_to 'email reviewers', :action => 'conflict_notification', :id => participant.id, :submission => 'review' %></FONT>
   	<% end %>  	 
   	</TD>
    <% else %>
   	<TD ALIGN="CENTER">---</TD>
    <TD ALIGN="CENTER">---</TD>
    <% end %>
    
    <% if r_avg %>
    <TD ALIGN="CENTER" VALIGN="TOP"><%= sprintf("%.2f",r_avg) %>%
    <BR/><FONT SIZE="-1"><a href="#" id="<%=prefix%>_mreviewsLink" name="<%=prefix%>_mreviewsLink" onClick="toggleElement('<%=prefix%>_mreviews','metareviews');return false;">show metareviews</a></FONT>
    </TD>
    <TD ALIGN="CENTER" VALIGN="TOP"><%= sprintf("%.0f",r_min) %>% - <%= sprintf("%.0f",r_max) %>%
    <% if controller.action_name != "view_my_scores" %>
      <BR/><FONT SIZE="-1"><%= link_to 'email metareviewers', :action => 'conflict_notification', :id => participant.id, :submission => 'review_of_review' %></FONT>
    <% end %>  	    
    </TD>
    <% else %>
    <TD ALIGN="CENTER">---</TD>
    <TD ALIGN="CENTER">---</TD>
    <% end %>
    
    <% if f_avg %>
    <TD ALIGN="CENTER" VALIGN="TOP"><%= sprintf("%.2f",f_avg) %>%
    <BR/><FONT SIZE="-1"><a href="#" id="<%=prefix%>_feedbackLink" name="<%=prefix%>_feedbackLink" onClick="toggleElement('<%=prefix%>_feedback','author feedbacks');return false;">show author feedbacks</a></FONT>
    </TD>
    <TD ALIGN="CENTER" VALIGN="TOP"><%= sprintf("%.0f",f_min) %>% - <%= sprintf("%.0f",f_max) %>%
    <% if controller.action_name != "view_my_scores" %>
      <BR/><FONT SIZE="-1"><%= link_to 'email authors', :action => 'conflict_notification', :id => participant.id, :submission => 'review_feedback' %></FONT>
    <% end %>  	    
    </TD>
    <% else %>
    <TD ALIGN="CENTER">---</TD>
    <TD ALIGN="CENTER">---</TD>
    <% end %>
    <% if @assignment.team_assignment %>
    <% if tr_avg %>
    <TD ALIGN="CENTER" VALIGN="TOP"><%= sprintf("%.2f",tr_avg) %>%
    <BR/><FONT SIZE="-1"><a href="#" id="<%=prefix%>_teammate_reviewsLink" name="<%=prefix%>_teammate_reviewsLink" onClick="toggleElement('<%=prefix%>_teammate_reviews','teammate reviews');return false;">show teammate reviews</a></FONT>
    </TD>
    <TD ALIGN="CENTER" VALIGN="TOP"><%= sprintf("%.0f",tr_min) %>% - <%= sprintf("%.0f",tr_max) %>%
    <% if controller.action_name != "view_my_scores" %>
      <BR/><FONT SIZE="-1"><%= link_to 'email authors', :action => 'conflict_notification', :id => participant.id, :submission => 'teammate_review' %></FONT>
    <% end %>  	    
    </TD>
    <% else %>
    <TD ALIGN="CENTER">---</TD>
    <TD ALIGN="CENTER">---</TD>
    <% end %>    
    <% end %>
    <% stage = participant.assignment.get_current_stage(participant.topic_id) %>
    <% if controller.action_name == 'view' or controller.action_name == "view_my_scores" %>
    	<TD ALIGN="CENTER">
    	<% if stage == "Complete" %>      
      	<% if participant.grade 
      	    total_score = participant.grade
      	    title = "A score in blue indicates that the value was overwritten by the instructor or teaching assistant."
      	   else
      	    total_score = pscore[:total_score] 
      	    title = nil
      	   end %>
      	<div <% if title %>title="<%=title%>" style="color:#0033FF"<% end %>><%= sprintf("%.2f",total_score) %>%</div>       	    
      	<% if controller.action_name != "view_my_scores" %> 
      	  <BR/><FONT SIZE="-1"><%= link_to 'edit score', :action => 'edit', :id => participant.id %></FONT>
      	<% end %>
    	<% else %>
      	<FONT SIZE="-1">(in <%= stage %>)</FONT>
    	<% end %>      
    	</TD>
   	<% else %>
   	    <% if participant.grade %>   	        
   	    	<TD ALIGN="CENTER"><%= text_field("participant", "grade", :size => 10) %>% </TD>
   	    <% else %>
   	        <TD ALIGN="CENTER"><%= text_field("participant", "grade", :size => 10, :value => sprintf("%.2f", pscore[:total_score])) %>% </TD>	    	
   	    <% end %>   	        
   	<% end %>

  <%String url =''
    temp_s_avg=0
    temp_r_avg=0
    temp_f_avg=0
    temp_tr_avg=0

    if s_avg then temp_s_avg=s_avg  end
    if r_avg then temp_r_avg=r_avg  end
    if f_avg then temp_f_avg=f_avg  end
    if tr_avg then temp_tr_avg=tr_avg end

    if @assignment.team_assignment
      url+='http://chart.apis.google.com/chart?chxp=2,10,50.83,90&chxt=x,y&chxl=0:|R|M|F|T&chxr=0:|1:0,0,100,25&cht=bvg&chco=FFC6A5|FFFF42|DEF3BD|00A5C6&chd=t:'+temp_s_avg.to_s+','+temp_r_avg.to_s+','+temp_f_avg.to_s+','+temp_tr_avg.to_s+'&chg=20,50&chdl=R-Review|M-MetaReview|F-Feedback|T-Teammate&chtt=%20Average%20Review%20Scores&chbh=a&chdlp=b'
    else
      url+='http://chart.apis.google.com/chart?chxp=2,10,50.83,90&chxt=x,y&chxl=0:|R|M|F&chxr=0:|1:0,0,100,25&cht=bvg&chco=FFC6A5|FFFF42|DEF3BD&chd=t:'+temp_s_avg.to_s+','+temp_r_avg.to_s+','+temp_f_avg.to_s+'&chg=20,50&chdl=R-Review|M-MetaReview|F-Feedback&chtt=%20Average%20Review%20Scores&chbh=a&chdlp=b'
    end
    String thumb_size='&chs=220x80&chts=676767,8';
    String large_img_size=url+'&chs=500x500&chts=676767,12';
  %>
  <TD ALIGN="CENTER">
    <a href="javascript:void(0)" onclick="window.open('<%=large_img_size%>','Scores per question by each reviewer','width=700, height=500').focus();return false;">
            <img src= <%=url%>+<%=thumb_size%> alt='average review score'/img>
    </a>
  </TD>
</TR>
<TR  class="row" id="<%= prefix %>_files" style="display:none">
	<TD COLSPAN="10"><%= render :partial=>'grades/submissions', :locals => {:participant => participant} %></TD>
</TR>
<TR  class="row" id="<%= prefix %>_reviews" style="display:none">
	<TD COLSPAN="11"><%= render :partial=>'grades/reviews', :locals => {:prefix => 'user', :participant => participant, :rscore => pscore[:review]} %></TD>
</TR>
<TR  class="row" id="<%= prefix %>_mreviews" style="display:none">
	<TD COLSPAN="11"><%= render :partial=>'grades/metareviews', :locals => {:prefix => prefix, :participant => participant, :rscore => pscore[:metareview]} %></TD>
</TR>
<TR  class="row" id="<%= prefix %>_feedback" style="display:none">
	<TD COLSPAN="11"><%= render :partial=>'grades/author_feedbacks', :locals => {:prefix => 'user', :participant => participant, :rscore => pscore[:feedback]} %></TD>
</TR>
<TR  class="row" id="<%= prefix %>_teammate_reviews" style="display:none">
	<TD COLSPAN="11"><%= render :partial=>'grades/teammate_reviews', :locals => {:prefix => prefix, :participant => participant, :rscore => pscore[:teammate]} %></TD>
</TR>
<!-- END PARTICIPANT -->